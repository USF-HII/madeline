#!/usr/bin/env bash

run_build() {
  docker build -t ${IMAGE_NAME}:latest .
}

run_container() {
  docker rm --force --volumes ${CONTAINER_NAME} &> /dev/null

  cid=$(docker run --rm --detach --publish 8000:80 --name=${CONTAINER_NAME} ${IMAGE_NAME}:latest)

  if [[ $? -ne 0 ]]; then
    docker run --rm --publish-all --name=${CONTAINER_NAME} ${IMAGE_NAME}:latest
    exit $?
  fi

  sleep 2

  docker ps --filter="id=${cid}"
}

run_test_submit() {
  port=$(docker port ${CONTAINER_NAME} | awk '{print $NF}' | awk -F: '{print $2}')


  curl \
    -X POST \
    --data-urlencode data@tests/data/cs_001.data http://localhost:${port}/submit

    #--custom-icon-colors 'ALS=red,PLS=purple,PMA=blue,HSP=green;A=black;FTD=black,Non-FTD=lightgray;A=black'" \
    #--data-urlencode args="--color --nolabeltruncation" \

  if [[ $? -ne 0 ]]; then
    echo docker logs ${CONTAINER_NAME} | bash -x
    exit 1
  fi
}

run_test_version() {
  port=$(docker port ${CONTAINER_NAME} | awk '{print $NF}' | awk -F: '{print $2}')

  echo curl http://localhost:${port}/version | bash -x
}


CONTAINER_NAME=madeline
IMAGE_NAME=madeline

case $1 in
  build)
    run_build
    ;;
  container)
    run_container
    ;;
  test)
    run_build
    run_container
    run_test_version
    run_test_submit
    ;;
  *) usage
    ;;
esac

